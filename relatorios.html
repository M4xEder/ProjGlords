<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Relat칩rios de Gaylords</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f4f4;
  padding:20px;
}

h1 { margin-bottom:10px; }

.box {
  background:#fff;
  padding:15px;
  border-radius:6px;
  margin-bottom:15px;
}

select, button {
  padding:6px 10px;
  margin-right:5px;
}

table {
  width:100%;
  border-collapse:collapse;
  background:#fff;
}

th, td {
  border:1px solid #ccc;
  padding:8px;
}

th { background:#eee; }

.ativo { color:green; font-weight:bold; }
.expedido { color:#b91c1c; font-weight:bold; }
.parcial { color:#b45309; font-weight:bold; }

.resumo {
  display:flex;
  gap:15px;
  flex-wrap:wrap;
}

.card {
  background:#fafafa;
  padding:10px;
  border-radius:6px;
  min-width:200px;
}

.alerta {
  background:#fff3cd;
  border:1px solid #ffeeba;
  padding:12px;
  border-radius:6px;
  margin-top:10px;
  color:#856404;
}
</style>
</head>

<body>

<h1>游늵 Relat칩rios de Gaylords</h1>

<div class="box">
  <label>
    Modo:
    <select id="modo" onchange="trocarModo()">
      <option value="operacional">Operacional</option>
      <option value="historico">Hist칩rico / Expedi칞칚o</option>
    </select>
  </label>

  <label>
    Lote:
    <select id="loteSelecionado"></select>
  </label>

  <button onclick="gerarRelatorio()">Gerar Relat칩rio</button>
  <button onclick="exportarCSV()">游닋 Exportar CSV</button>

  <button onclick="exportarExcel()">游늵 Exportar Lote Selecionado</button>
<button onclick="exportarExcelPorLote()">游닍 Exportar Todos os Lotes</button>
</div>

<div id="resumo" class="resumo"></div>
<div id="mensagemParcial"></div>

<table>
<thead>
<tr id="cabecalho"></tr>
</thead>
<tbody id="tabela"></tbody>
</table>
<script>
/* =====================
   DADOS
===================== */
const mapa = JSON.parse(localStorage.getItem('mapa')) || [];
const lotes = JSON.parse(localStorage.getItem('lotes')) || {};
const historicoExpedidos = JSON.parse(localStorage.getItem('historicoExpedidos')) || [];

const select = document.getElementById('loteSelecionado');
const resumo = document.getElementById('resumo');
const tabela = document.getElementById('tabela');
const mensagemParcial = document.getElementById('mensagemParcial');

/* =====================
   CARREGAR LOTES
===================== */
function carregarLotes() {
  select.innerHTML = '<option value="">Selecione</option>';

  Object.keys(lotes).forEach(lote => {
    const opt = document.createElement('option');
    opt.value = lote;
    opt.textContent = `${lote} (Ativo)`;
    select.appendChild(opt);
  });

  historicoExpedidos.forEach(h => {
    if (![...select.options].some(o => o.value === h.lote)) {
      const opt = document.createElement('option');
      opt.value = h.lote;
      opt.textContent = `${h.lote} (Expedido)`;
      select.appendChild(opt);
    }
  });
}

carregarLotes();

/* =====================
   GERAR RELAT칍RIO
===================== */
function gerarRelatorio() {
  const lote = select.value;
  if (!lote) {
    alert('Selecione um lote');
    return;
  }

  tabela.innerHTML = '';
  resumo.innerHTML = '';
  mensagemParcial.innerHTML = '';

  let totalCriado = 0;
  let expedidos = 0;
  let alocados = 0;

  /* =====================
     TOTAL ORIGINAL DO LOTE
  ===================== */
  const historicosDoLote = historicoExpedidos.filter(h => h.lote === lote);

  if (historicosDoLote.length > 0) {
    totalCriado = historicosDoLote[0].totalOriginal;
  } else if (lotes[lote]) {
    totalCriado = lotes[lote].total;
  }

  /* =====================
     EXPEDIDOS
  ===================== */
  historicosDoLote.forEach(h => {
    expedidos += h.expedidos;

    h.detalhes.forEach(d => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="expedido">Expedida</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>${d.rz || '-'}</td>
        <td>${d.volume || '-'}</td>
      `;
      tabela.appendChild(tr);
    });
  });

  /* =====================
     ALOCADAS (N츾O EXPEDIDAS)
  ===================== */
  mapa.forEach(area => {
    area.ruas.forEach(rua => {
      rua.posicoes.forEach((pos, i) => {
        if (!pos || pos.lote !== lote) return;

        alocados++;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="ativo">Alocada (n칚o expedida)</td>
          <td>${area.nome}</td>
          <td>${rua.nome}</td>
          <td>${i + 1}</td>
          <td>${pos.rz || '-'}</td>
          <td>${pos.volume || '-'}</td>
        `;
        tabela.appendChild(tr);
      });
    });
  });

  /* =====================
     N츾O ALOCADAS
  ===================== */
  const naoAlocadas = Math.max(
    totalCriado - expedidos - alocados,
    0
  );

  /* =====================
     MENSAGEM DE EXPEDI칂츾O PARCIAL
  ===================== */
  if (expedidos > 0 && expedidos < totalCriado) {
    mensagemParcial.innerHTML = `
      <div class="alerta">
        丘멆잺 <strong>Expedi칞칚o parcial do lote ${lote}</strong><br><br>

        Total do lote: <strong>${totalCriado}</strong><br>
        Expedidas: <strong>${expedidos}</strong><br>
        Alocadas (n칚o expedidas): <strong>${alocados}</strong><br>
        N칚o alocadas: <strong>${naoAlocadas}</strong><br><br>

        As gaylords n칚o alocadas n칚o possuem RZ nem Volume.
      </div>
    `;
  }

  /* =====================
     STATUS
  ===================== */
  let status = 'Ativo';

  if (expedidos > 0 && alocados > 0 && naoAlocadas > 0) {
    status = 'Parcialmente expedido';
  } else if (expedidos > 0 && alocados === 0 && naoAlocadas === 0) {
    status = 'Totalmente expedido';
  }

  /* =====================
     RESUMO
  ===================== */
  resumo.innerHTML = `
    <div class="card"><strong>Lote:</strong> ${lote}</div>
    <div class="card"><strong>Status:</strong> ${status}</div>
    <div class="card"><strong>Total criado:</strong> ${totalCriado}</div>
    <div class="card"><strong>Expedidos:</strong> ${expedidos}</div>
    <div class="card"><strong>Alocados:</strong> ${alocados}</div>
    <div class="card"><strong>N칚o alocados:</strong> ${naoAlocadas}</div>
  `;
}

/* =====================
   EXPORTAR CSV
===================== */
function exportarCSV() {
  if (!select.value) {
    alert('Selecione um lote');
    return;
  }

  let csv = 'Status,츼rea,Rua,Endere칞o,RZ,Volume\n';

  document.querySelectorAll('#tabela tr').forEach(tr => {
    const cols = [...tr.children].map(td => `"${td.innerText}"`);
    csv += cols.join(',') + '\n';
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `relatorio_${select.value}.csv`;
  link.click();
}
</script>
</body>
</html>
