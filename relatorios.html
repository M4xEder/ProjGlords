<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Relat√≥rio por Lote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }

    h1, h2 {
      margin-bottom: 10px;
    }

    .box {
      background: #fff;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
    }

    select, button {
      padding: 6px 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }

    th {
      background: #eee;
    }

    .ativo {
      color: green;
      font-weight: bold;
    }

    .expedido {
      color: #b91c1c;
      font-weight: bold;
    }

    .parcial {
      color: #b45309;
      font-weight: bold;
    }
  </style>
</head>

<body>

<h1>üìä Relat√≥rio Individual por Lote</h1>

<div class="box">
  <label>
    Lote:
    <select id="loteSelecionado"></select>
  </label>
  <button onclick="gerarRelatorio()">Gerar Relat√≥rio</button>
  <button onclick="exportarCSV()">üì§ Exportar CSV</button>
</div>

<div id="resumo" class="box"></div>

<h2>Detalhamento</h2>
<table>
  <thead>
    <tr>
      <th>Status</th>
      <th>√Årea</th>
      <th>Rua</th>
      <th>Endere√ßo</th>
      <th>RZ</th>
      <th>Volume</th>
    </tr>
  </thead>
  <tbody id="tabela"></tbody>
</table>

<h2>Hist√≥rico de Expedi√ß√£o</h2>
<div id="historico" class="box"></div>

<script>
/* =====================
   DADOS
===================== */
const mapa = JSON.parse(localStorage.getItem('mapa')) || [];
const lotes = JSON.parse(localStorage.getItem('lotes')) || {};
const historicoExpedidos = JSON.parse(localStorage.getItem('historicoExpedidos')) || [];

const select = document.getElementById('loteSelecionado');
const resumo = document.getElementById('resumo');
const tabela = document.getElementById('tabela');
const historicoDiv = document.getElementById('historico');

/* =====================
   CARREGAR LOTES
===================== */
function carregarLotes() {
  select.innerHTML = '<option value="">Selecione</option>';

  Object.keys(lotes).forEach(lote => {
    const opt = document.createElement('option');
    opt.value = lote;
    opt.textContent = lote + ' (Ativo)';
    select.appendChild(opt);
  });

  historicoExpedidos.forEach(h => {
    const opt = document.createElement('option');
    opt.value = h.lote;
    opt.textContent = h.lote + ' (Expedido)';
    select.appendChild(opt);
  });
}

carregarLotes();

/* =====================
   GERAR RELAT√ìRIO
===================== */
function gerarRelatorio() {
  const lote = select.value;
  if (!lote) return alert('Selecione um lote');

  tabela.innerHTML = '';
  historicoDiv.innerHTML = '';

  let totalCriado = lotes[lote]?.total || 0;
  let alocados = 0;
  let expedidos = 0;

  // ATIVOS
  mapa.forEach(area => {
    area.ruas.forEach(rua => {
      rua.posicoes.forEach((pos, i) => {
        if (pos?.lote !== lote) return;

        alocados++;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="ativo">Ativa</td>
          <td>${area.nome}</td>
          <td>${rua.nome}</td>
          <td>${i + 1}</td>
          <td>${pos.rz}</td>
          <td>${pos.volume || '-'}</td>
        `;
        tabela.appendChild(tr);
      });
    });
  });

  // EXPEDIDOS
  historicoExpedidos
    .filter(h => h.lote === lote)
    .forEach(h => {
      expedidos += h.detalhes.length;

      h.detalhes.forEach(d => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="expedido">Expedida</td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
          <td>${d.rz}</td>
          <td>${d.volume || '-'}</td>
        `;
        tabela.appendChild(tr);
      });

      historicoDiv.innerHTML += `
        <div>
          ${h.dataHora} ‚Äî ${h.parcial ? 'Expedi√ß√£o parcial' : 'Expedi√ß√£o total'}
        </div>
      `;
    });

  const disponivel = totalCriado - alocados - expedidos;
  let status = 'Ativo';
  if (expedidos > 0 && alocados > 0) status = 'Parcialmente expedido';
  if (expedidos > 0 && alocados === 0) status = 'Totalmente expedido';

  resumo.innerHTML = `
    <strong>Lote:</strong> ${lote}<br>
    <strong>Status:</strong> <span class="${status === 'Ativo' ? 'ativo' : status === 'Parcialmente expedido' ? 'parcial' : 'expedido'}">${status}</span><br>
    <strong>Total criado:</strong> ${totalCriado}<br>
    <strong>Alocados:</strong> ${alocados}<br>
    <strong>Expedidos:</strong> ${expedidos}<br>
    <strong>Dispon√≠veis:</strong> ${disponivel}
  `;
}

/* =====================
   EXPORTAR CSV
===================== */
function exportarCSV() {
  let csv = 'Status,√Årea,Rua,Endere√ßo,RZ,Volume\n';

  document.querySelectorAll('#tabela tr').forEach(tr => {
    const cols = [...tr.children].map(td => `"${td.innerText}"`);
    csv += cols.join(',') + '\n';
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `relatorio_${select.value}.csv`;
  link.click();
}
</script>

</body>
</html>
