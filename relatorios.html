<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Relat칩rios de Gaylords</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f4f4;
  padding:20px;
}

h1 { margin-bottom:10px; }

.box {
  background:#fff;
  padding:15px;
  border-radius:6px;
  margin-bottom:15px;
}

select, button {
  padding:6px 10px;
  margin-right:5px;
}

table {
  width:100%;
  border-collapse:collapse;
  background:#fff;
}

th, td {
  border:1px solid #ccc;
  padding:8px;
}

th { background:#eee; }

.ativo { color:green; font-weight:bold; }
.expedido { color:#b91c1c; font-weight:bold; }
.parcial { color:#b45309; font-weight:bold; }

.resumo {
  display:flex;
  gap:15px;
  flex-wrap:wrap;
}

.card {
  background:#fafafa;
  padding:10px;
  border-radius:6px;
  min-width:200px;
}

.alerta {
  background:#fff3cd;
  border:1px solid #ffeeba;
  padding:12px;
  border-radius:6px;
  margin-top:10px;
  color:#856404;
}
</style>
</head>

<body>

<h1>游늵 Relat칩rios de Gaylords</h1>

<div class="box">
  <label>
    Modo:
    <select id="modo" onchange="trocarModo()">
      <option value="operacional">Operacional</option>
      <option value="historico">Hist칩rico / Expedi칞칚o</option>
    </select>
  </label>

  <label>
    Lote:
    <select id="loteSelecionado"></select>
  </label>

  <button onclick="gerarRelatorio()">Gerar Relat칩rio</button>
  <button onclick="exportarCSV()">游닋 Exportar CSV</button>
</div>

<div id="resumo" class="resumo"></div>
<div id="mensagemParcial"></div>

<table>
<thead>
<tr id="cabecalho"></tr>
</thead>
<tbody id="tabela"></tbody>
</table>

<script>
/* ======================
   DADOS
====================== */
const mapa = JSON.parse(localStorage.getItem('mapa')) || [];
const lotes = JSON.parse(localStorage.getItem('lotes')) || {};
const historicoExpedidos = JSON.parse(localStorage.getItem('historicoExpedidos')) || [];

const modoSelect = document.getElementById('modo');
const loteSelect = document.getElementById('loteSelecionado');
const resumo = document.getElementById('resumo');
const tabela = document.getElementById('tabela');
const cabecalho = document.getElementById('cabecalho');
const mensagemParcial = document.getElementById('mensagemParcial');

/* ======================
   MODO
====================== */
function trocarModo() {
  carregarLotes();
  resumo.innerHTML = '';
  tabela.innerHTML = '';
  cabecalho.innerHTML = '';
  mensagemParcial.innerHTML = '';
}

function carregarLotes() {
  loteSelect.innerHTML = '<option value="">Selecione</option>';

  if (modoSelect.value === 'operacional') {
    Object.keys(lotes).forEach(l => {
      const opt = document.createElement('option');
      opt.value = l;
      opt.textContent = l + ' (Ativo)';
      loteSelect.appendChild(opt);
    });
  } else {
    [...new Set(historicoExpedidos.map(h => h.lote))].forEach(l => {
      const opt = document.createElement('option');
      opt.value = l;
      opt.textContent = l + ' (Expedido)';
      loteSelect.appendChild(opt);
    });
  }
}

trocarModo();

/* ======================
   RELAT칍RIO
====================== */
function gerarRelatorio() {
  const lote = loteSelect.value;
  if (!lote) return alert('Selecione um lote');

  resumo.innerHTML = '';
  tabela.innerHTML = '';
  mensagemParcial.innerHTML = '';

  if (modoSelect.value === 'operacional') {
    gerarOperacional(lote);
  } else {
    gerarHistorico(lote);
  }
}

/* ======================
   OPERACIONAL
====================== */
function gerarOperacional(lote) {
  cabecalho.innerHTML = `
    <th>Status</th>
    <th>츼rea</th>
    <th>Rua</th>
    <th>Endere칞o</th>
    <th>RZ</th>
    <th>Volume</th>
  `;

  let alocados = 0;

  mapa.forEach(area => {
    area.ruas.forEach(rua => {
      rua.posicoes.forEach((pos, i) => {
        if (pos?.lote !== lote) return;

        alocados++;

        tabela.innerHTML += `
          <tr>
            <td class="ativo">Ativa</td>
            <td>${area.nome}</td>
            <td>${rua.nome}</td>
            <td>${i + 1}</td>
            <td>${pos.rz}</td>
            <td>${pos.volume || '-'}</td>
          </tr>
        `;
      });
    });
  });

  const total = lotes[lote]?.total || 0;

  resumo.innerHTML = `
    <div class="card">游닍 Total criado: <strong>${total}</strong></div>
    <div class="card">游늸 Alocados: <strong>${alocados}</strong></div>
    <div class="card">游닔 Dispon칤veis: <strong>${total - alocados}</strong></div>
  `;
}

/* ======================
   HIST칍RICO (COM AVISO)
====================== */
function gerarHistorico(lote) {
  cabecalho.innerHTML = `
    <th>Data</th>
    <th>Hora</th>
    <th>RZ</th>
    <th>Volume</th>
    <th>Tipo</th>
  `;

  let totalExpedido = 0;
  let houveParcial = false;

  historicoExpedidos
    .filter(h => h.lote === lote)
    .forEach(h => {
      if (h.parcial) houveParcial = true;

      const data = new Date(h.dataHora || `${h.data} ${h.hora}`);

      h.detalhes.forEach(d => {
        totalExpedido++;
        tabela.innerHTML += `
          <tr>
            <td>${data.toLocaleDateString()}</td>
            <td>${data.toLocaleTimeString()}</td>
            <td>${d.rz}</td>
            <td>${d.volume || '-'}</td>
            <td>${h.parcial ? 'Parcial' : 'Total'}</td>
          </tr>
        `;
      });
    });

  const totalCriado = lotes[lote]?.total || totalExpedido;
  const naoExpedido = totalCriado - totalExpedido;

  resumo.innerHTML = `
    <div class="card">游닍 Total criado: <strong>${totalCriado}</strong></div>
    <div class="card">游뚴 Total expedido: <strong>${totalExpedido}</strong></div>
  `;

  if (houveParcial && naoExpedido > 0) {
    mensagemParcial.innerHTML = `
      <div class="alerta">
        丘멆잺 <strong>Expedi칞칚o incompleta</strong><br><br>
        Quantidade expedida: <strong>${totalExpedido}</strong><br>
        Quantidade n칚o expedida: <strong>${naoExpedido}</strong><br><br>
        Esses volumes <strong>n칚o foram alocados para expedi칞칚o</strong>, 
        portanto <strong>n칚o possuem RZ nem Volume</strong>.
      </div>
    `;
  }
}

/* ======================
   EXPORTAR CSV
====================== */
function exportarCSV() {
  if (!tabela.innerHTML) return alert('Gere o relat칩rio primeiro');

  let csv = '';
  document.querySelectorAll('thead th').forEach(th => {
    csv += `"${th.innerText}",`;
  });
  csv = csv.slice(0, -1) + '\n';

  document.querySelectorAll('tbody tr').forEach(tr => {
    [...tr.children].forEach(td => {
      csv += `"${td.innerText}",`;
    });
    csv = csv.slice(0, -1) + '\n';
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `relatorio_${loteSelecionado.value}.csv`;
  link.click();
}
</script>

</body>
</html>
