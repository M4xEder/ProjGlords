<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Relat√≥rios de Gaylords</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f4f4;
  padding:20px;
}

.box {
  background:#fff;
  padding:15px;
  border-radius:6px;
  margin-bottom:15px;
}

select, button {
  padding:6px 12px;
  margin-right:6px;
  cursor:pointer;
}

table {
  width:100%;
  border-collapse:collapse;
  background:#fff;
}

th, td {
  border:1px solid #ccc;
  padding:8px;
}

th { background:#eee; }

.ativo { color:green; font-weight:bold; }
.expedido { color:#b91c1c; font-weight:bold; }

.resumo {
  display:flex;
  gap:15px;
  flex-wrap:wrap;
}

.card {
  background:#fafafa;
  padding:10px;
  border-radius:6px;
  min-width:200px;
}

.alerta {
  background:#fff3cd;
  border:1px solid #ffeeba;
  padding:12px;
  border-radius:6px;
  margin-bottom:10px;
  color:#856404;
}
</style>
</head>

<body>

<h1>üìä Relat√≥rios de Gaylords</h1>

<div class="box">
  <label>
    Lote:
    <select id="loteSelecionado"></select>
  </label>

  <button onclick="gerarRelatorio()">Gerar Relat√≥rio</button>
  <button onclick="exportarExcelLote()">üìä Excel (Lote)</button>
  <button onclick="exportarExcelTodos()">üì¶ Excel (Todos)</button>
  <button onclick="exportarCSVLote()">üìÑ CSV (Lote)</button>
  <button onclick="exportarCSVTodos()">üì¶ CSV (Todos)</button>
</div>

<div id="mensagem" class="alerta" style="display:none"></div>
<div id="resumo" class="resumo"></div>

<table>
<thead>
<tr>
  <th>Status</th>
  <th>√Årea</th>
  <th>Rua</th>
  <th>Endere√ßo</th>
  <th>RZ</th>
  <th>Volume</th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
// =====================
// DADOS
// =====================
const mapa = JSON.parse(localStorage.getItem('mapa')) || [];
const lotes = JSON.parse(localStorage.getItem('lotes')) || {};
const historicoExpedidos = JSON.parse(localStorage.getItem('historicoExpedidos')) || [];

const select = document.getElementById('loteSelecionado');
const tabela = document.getElementById('tabela');
const resumo = document.getElementById('resumo');
const mensagem = document.getElementById('mensagem');

// =====================
// CARREGAR LOTES
// =====================
(function carregarLotes(){
  const set = new Set();
  Object.keys(lotes).forEach(l=>set.add(l));
  historicoExpedidos.forEach(h=>set.add(h.lote));

  select.innerHTML = '<option value="">Selecione</option>';
  set.forEach(l=>{
    const o=document.createElement('option');
    o.value=l;
    o.textContent=l;
    select.appendChild(o);
  });
})();

// =====================
// GERAR RELAT√ìRIO
// =====================
function gerarRelatorio(){
  const lote = select.value;
  if(!lote) return alert('Selecione um lote');

  tabela.innerHTML='';
  resumo.innerHTML='';
  mensagem.style.display='none';

  let total=0, expedidos=0, alocados=0;
  const historico = historicoExpedidos.filter(h=>h.lote===lote);

  if(historico.length) total=historico[0].totalOriginal;
  else if(lotes[lote]) total=lotes[lote].total;

  historico.forEach(h=>{
    expedidos+=h.expedidos;
    h.detalhes.forEach(d=>{
      tabela.innerHTML+=`
      <tr>
        <td class="expedido">Expedida</td>
        <td>-</td><td>-</td><td>-</td>
        <td>${d.rz}</td>
        <td>${d.volume||''}</td>
      </tr>`;
    });
  });

  mapa.forEach(a=>a.ruas.forEach(r=>r.posicoes.forEach((p,i)=>{
    if(p?.lote!==lote) return;
    alocados++;
    tabela.innerHTML+=`
    <tr>
      <td class="ativo">Alocada</td>
      <td>${a.nome}</td>
      <td>${r.nome}</td>
      <td>${i+1}</td>
      <td>${p.rz}</td>
      <td>${p.volume||''}</td>
    </tr>`;
  })));

  const naoAlocadas = Math.max(total-expedidos-alocados,0);

  if(expedidos>0 && (alocados>0||naoAlocadas>0)){
    mensagem.style.display='block';
    mensagem.innerHTML=`
      ‚ö†Ô∏è Expedi√ß√£o parcial<br>
      Total: ${total}<br>
      Expedidas: ${expedidos}<br>
      Alocadas: ${alocados}<br>
      N√£o alocadas: ${naoAlocadas} (sem RZ e Volume)
    `;
  }

  resumo.innerHTML=`
    <div class="card">Total: ${total}</div>
    <div class="card">Expedidas: ${expedidos}</div>
    <div class="card">Alocadas: ${alocados}</div>
    <div class="card">N√£o alocadas: ${naoAlocadas}</div>
  `;
}

// =====================
// GERAR LINHAS
// =====================
function gerarLinhas(lote){
  let linhas=[];
  let total=0, expedidos=0, alocados=0;
  const hist = historicoExpedidos.filter(h=>h.lote===lote);

  if(hist.length) total=hist[0].totalOriginal;
  else if(lotes[lote]) total=lotes[lote].total;

  hist.forEach(h=>{
    expedidos+=h.expedidos;
    h.detalhes.forEach(d=>linhas.push({
      Status:'Expedida',RZ:d.rz,Volume:d.volume||''
    }));
  });

  mapa.forEach(a=>a.ruas.forEach(r=>r.posicoes.forEach(p=>{
    if(p?.lote===lote){
      alocados++;
      linhas.push({Status:'Alocada',RZ:p.rz,Volume:p.volume||''});
    }
  })));

  for(let i=0;i<Math.max(total-expedidos-alocados,0);i++){
    linhas.push({Status:'N√£o alocada',RZ:'',Volume:''});
  }
  return linhas;
}

// =====================
// EXCEL
// =====================
function exportarExcelLote(){
  const lote=select.value;
  if(!lote) return alert('Selecione um lote');
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,
    XLSX.utils.json_to_sheet(gerarLinhas(lote)),
    `Lote_${lote}`.substring(0,31)
  );
  XLSX.writeFile(wb,`relatorio_${lote}.xlsx`);
}

function exportarExcelTodos(){
  const wb=XLSX.utils.book_new();
  const set=new Set();
  Object.keys(lotes).forEach(l=>set.add(l));
  historicoExpedidos.forEach(h=>set.add(h.lote));

  set.forEach(l=>{
    const linhas=gerarLinhas(l);
    if(linhas.length){
      XLSX.utils.book_append_sheet(
        wb,
        XLSX.utils.json_to_sheet(linhas),
        `Lote_${l}`.substring(0,31)
      );
    }
  });
  XLSX.writeFile(wb,'relatorio_todos_lotes.xlsx');
}

// =====================
// CSV
// =====================
function exportarCSVLote(){
  const lote=select.value;
  if(!lote) return alert('Selecione um lote');
  baixarCSV(`relatorio_${lote}.csv`, gerarLinhas(lote));
}

function exportarCSVTodos(){
  const set=new Set();
  Object.keys(lotes).forEach(l=>set.add(l));
  historicoExpedidos.forEach(h=>set.add(h.lote));

  set.forEach(l=>{
    const linhas=gerarLinhas(l);
    if(linhas.length){
      baixarCSV(`relatorio_${l}.csv`, linhas);
    }
  });
}

function baixarCSV(nome, dados){
  let csv='Status,RZ,Volume\n';
  dados.forEach(l=>{
    csv+=`"${l.Status}","${l.RZ}","${l.Volume}"\n`;
  });
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=nome;
  a.click();
}
</script>

</body>
</html>
