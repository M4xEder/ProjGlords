<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Relat√≥rios de Gaylords</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f4f4;
  padding:20px;
}

h1 { margin-bottom:10px; }

.box {
  background:#fff;
  padding:15px;
  border-radius:6px;
  margin-bottom:15px;
}

select, button {
  padding:6px 10px;
  margin-right:5px;
}

table {
  width:100%;
  border-collapse:collapse;
  background:#fff;
}

th, td {
  border:1px solid #ccc;
  padding:8px;
}

th { background:#eee; }

.ativo { color:green; font-weight:bold; }
.expedido { color:#b91c1c; font-weight:bold; }
.parcial { color:#b45309; font-weight:bold; }

.resumo {
  display:flex;
  gap:15px;
  flex-wrap:wrap;
}

.card {
  background:#fafafa;
  padding:10px;
  border-radius:6px;
  min-width:220px;
}

.alerta {
  background:#fff3cd;
  border:1px solid #ffeeba;
  padding:12px;
  border-radius:6px;
  margin-top:10px;
  color:#856404;
}
</style>
</head>

<body>

<h1>üìä Relat√≥rios de Gaylords</h1>

<div class="box">
  <label>
    Lote:
    <select id="loteSelecionado"></select>
  </label>

  <button onclick="gerarRelatorio()">Gerar Relat√≥rio</button>
  <button onclick="exportarExcelLote()">üìä Exportar Lote</button>
  <button onclick="exportarExcelTodos()">üì¶ Exportar Todos</button>
</div>

<div id="resumo" class="resumo"></div>
<div id="mensagem" class="alerta" style="display:none"></div>

<table>
<thead>
<tr>
  <th>Status</th>
  <th>√Årea</th>
  <th>Rua</th>
  <th>Endere√ßo</th>
  <th>RZ</th>
  <th>Volume</th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>

<!-- LIB EXCEL -->
<script>
/* =====================
   DADOS
===================== */
const mapa = JSON.parse(localStorage.getItem('mapa')) || [];
const lotes = JSON.parse(localStorage.getItem('lotes')) || {};
const historicoExpedidos = JSON.parse(localStorage.getItem('historicoExpedidos')) || [];

const select = document.getElementById('loteSelecionado');
const tabela = document.getElementById('tabela');
const resumo = document.getElementById('resumo');
const mensagem = document.getElementById('mensagem');

/* =====================
   CARREGAR LOTES
===================== */
(function carregarLotes() {
  const set = new Set();
  Object.keys(lotes).forEach(l => set.add(l));
  historicoExpedidos.forEach(h => set.add(h.lote));

  select.innerHTML = '<option value="">Selecione</option>';
  set.forEach(l => {
    const opt = document.createElement('option');
    opt.value = l;
    opt.textContent = l;
    select.appendChild(opt);
  });
})();

/* =====================
   GERAR RELAT√ìRIO
===================== */
function gerarRelatorio() {
  const lote = select.value;
  if (!lote) return alert('Selecione um lote');

  tabela.innerHTML = '';
  resumo.innerHTML = '';
  mensagem.style.display = 'none';
  mensagem.innerHTML = '';

  let total = 0;
  let expedidos = 0;
  let alocados = 0;

  const historico = historicoExpedidos.filter(h => h.lote === lote);

  if (historico.length > 0) total = historico[0].totalOriginal;
  else if (lotes[lote]) total = lotes[lote].total;

  /* ========= EXPEDIDOS ========= */
  historico.forEach(h => {
    expedidos += h.expedidos;

    h.detalhes.forEach(d => {
      tabela.innerHTML += `
        <tr>
          <td class="expedido">Expedida</td>
          <td>-</td><td>-</td><td>-</td>
          <td>${d.rz}</td>
          <td>${d.volume || '-'}</td>
        </tr>`;
    });
  });

  /* ========= ALOCADAS ========= */
  mapa.forEach(area => {
    area.ruas.forEach(rua => {
      rua.posicoes.forEach((pos, i) => {
        if (pos?.lote !== lote) return;
        alocados++;
        tabela.innerHTML += `
          <tr>
            <td class="ativo">Alocada</td>
            <td>${area.nome}</td>
            <td>${rua.nome}</td>
            <td>${i + 1}</td>
            <td>${pos.rz}</td>
            <td>${pos.volume || '-'}</td>
          </tr>`;
      });
    });
  });

  /* ========= N√ÉO ALOCADAS ========= */
  const naoAlocadas = Math.max(total - expedidos - alocados, 0);

  if (expedidos > 0 && (alocados > 0 || naoAlocadas > 0)) {
    mensagem.style.display = 'block';
    mensagem.innerHTML = `
      ‚ö†Ô∏è <strong>Expedi√ß√£o parcial</strong><br>
      Total do lote: ${total}<br>
      Expedidas: ${expedidos}<br>
      Alocadas: ${alocados}<br>
      N√£o alocadas: ${naoAlocadas} (sem RZ e Volume)
    `;
  }

  resumo.innerHTML = `
    <div class="card">Total: ${total}</div>
    <div class="card">Expedidas: ${expedidos}</div>
    <div class="card">Alocadas: ${alocados}</div>
    <div class="card">N√£o alocadas: ${naoAlocadas}</div>
  `;
}

/* =====================
   EXPORTAR EXCEL - LOTE
===================== */
function exportarExcelLote() {
  const lote = select.value;
  if (!lote) return alert('Selecione um lote');

  const wb = XLSX.utils.book_new();
  let linhas = [];

  historicoExpedidos
    .filter(h => h.lote === lote)
    .forEach(h => {
      h.detalhes.forEach(d => {
        linhas.push({
          Status: 'Expedida',
          √Årea: '',
          Rua: '',
          Endere√ßo: '',
          RZ: d.rz,
          Volume: d.volume || ''
        });
      });
    });

  mapa.forEach(area => {
    area.ruas.forEach(rua => {
      rua.posicoes.forEach((pos, i) => {
        if (pos?.lote === lote) {
          linhas.push({
            Status: 'Alocada',
            √Årea: area.nome,
            Rua: rua.nome,
            Endere√ßo: i + 1,
            RZ: pos.rz,
            Volume: pos.volume || ''
          });
        }
      });
    });
  });

  let total = 0;
  const h = historicoExpedidos.find(h => h.lote === lote);
  if (h) total = h.totalOriginal;
  else if (lotes[lote]) total = lotes[lote].total;

  const naoAlocadas = total - linhas.length;

  for (let i = 0; i < naoAlocadas; i++) {
    linhas.push({
      Status: 'N√£o alocada',
      √Årea: '',
      Rua: '',
      Endere√ßo: '',
      RZ: '',
      Volume: ''
    });
  }

  const ws = XLSX.utils.json_to_sheet(linhas);
  XLSX.utils.book_append_sheet(wb, ws, `Lote_${lote}`.substring(0, 31));
  XLSX.writeFile(wb, `relatorio_lote_${lote}.xlsx`);
}

/* =====================
   EXPORTAR EXCEL - TODOS
===================== */
function exportarExcelTodos() {
  const wb = XLSX.utils.book_new();
  const set = new Set();

  Object.keys(lotes).forEach(l => set.add(l));
  historicoExpedidos.forEach(h => set.add(h.lote));

  set.forEach(lote => {
    let linhas = [];

    historicoExpedidos
      .filter(h => h.lote === lote)
      .forEach(h => {
        h.detalhes.forEach(d => {
          linhas.push({
            Status: 'Expedida',
            √Årea: '',
            Rua: '',
            Endere√ßo: '',
            RZ: d.rz,
            Volume: d.volume || ''
          });
        });
      });

    mapa.forEach(area => {
      area.ruas.forEach(rua => {
        rua.posicoes.forEach((pos, i) => {
          if (pos?.lote === lote) {
            linhas.push({
              Status: 'Alocada',
              √Årea: area.nome,
              Rua: rua.nome,
              Endere√ßo: i + 1,
              RZ: pos.rz,
              Volume: pos.volume || ''
            });
          }
        });
      });
    });

    if (linhas.length > 0) {
      const ws = XLSX.utils.json_to_sheet(linhas);
      XLSX.utils.book_append_sheet(
        wb,
        ws,
        `Lote_${lote}`.substring(0, 31)
      );
    }
  });

  XLSX.writeFile(wb, 'relatorio_completo_gaylords.xlsx');
}
</script>
</body>
</html>
