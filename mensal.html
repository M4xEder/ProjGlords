<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>RelatÃ³rio Mensal de ExpediÃ§Ãµes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f4f4;
  padding: 20px;
}

h1, h2 {
  margin-bottom: 10px;
}

.box {
  background: #fff;
  padding: 15px;
  border-radius: 6px;
  margin-bottom: 15px;
}

button {
  padding: 6px 12px;
  cursor: pointer;
}

.resumo {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
  margin-bottom: 15px;
}

.card {
  background: #fff;
  padding: 12px;
  border-radius: 6px;
  min-width: 180px;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
  margin-bottom: 20px;
}

th, td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
}

th {
  background: #eee;
}
</style>
</head>

<body>

<h1>ðŸ“… RelatÃ³rio Mensal de ExpediÃ§Ãµes</h1>

<div class="box">
  <label>
    MÃªs:
    <input type="month" id="mesSelecionado">
  </label>

  <button onclick="gerarRelatorio()">Gerar RelatÃ³rio</button>
  <button onclick="exportarExcel()">ðŸ“Š Exportar Excel</button>
</div>

<div class="resumo" id="resumo"></div>

<h2>ðŸ“¦ Ranking por Lote</h2>
<table>
  <thead>
    <tr>
      <th>Lote</th>
      <th>Quantidade Expedida</th>
    </tr>
  </thead>
  <tbody id="ranking"></tbody>
</table>

<h2>ðŸ“‹ Detalhamento do MÃªs</h2>
<table>
  <thead>
    <tr>
      <th>Data</th>
      <th>Hora</th>
      <th>Lote</th>
      <th>RZ</th>
      <th>Volume</th>
      <th>Tipo</th>
    </tr>
  </thead>
  <tbody id="detalhes"></tbody>
</table>

<!-- BIBLIOTECA EXCEL (OBRIGATÃ“RIA) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
// =======================
// ESTADO GLOBAL
// =======================
let mapa = JSON.parse(localStorage.getItem('mapa')) || [];
let lotes = JSON.parse(localStorage.getItem('lotes')) || {};
let historicoExpedidos = JSON.parse(localStorage.getItem('historicoExpedidos')) || [];
let posicaoAtual = null;

// =======================
// UTIL
// =======================
function salvarTudo() {
  localStorage.setItem('mapa', JSON.stringify(mapa));
  localStorage.setItem('lotes', JSON.stringify(lotes));
  localStorage.setItem('historicoExpedidos', JSON.stringify(historicoExpedidos));
}

function gerarCor() {
  return `hsl(${Math.random() * 360},70%,70%)`;
}

// =======================
// CONTADOR DE ALOCADOS
// =======================
function contarAlocados(lote) {
  let total = 0;
  mapa.forEach(a =>
    a.ruas.forEach(r =>
      r.posicoes.forEach(p => {
        if (p && p.lote === lote) total++;
      })
    )
  );
  return total;
}

// =======================
// CADASTRO DE LOTE
// =======================
function cadastrarLote(nome, total) {
  if (!nome || total <= 0) return alert('Dados invÃ¡lidos');

  lotes[nome] = {
    total,
    cor: gerarCor()
  };

  salvarTudo();
  renderLotes();
}

// =======================
// EXPEDIÃ‡ÃƒO (FUNÃ‡ÃƒO CRÃTICA)
// =======================
function expedirLote(nomeLote) {
  if (!lotes[nomeLote]) return;

  const totalLote = lotes[nomeLote].total;
  const detalhes = [];

  // coleta todas as gaylords alocadas
  mapa.forEach(area =>
    area.ruas.forEach(rua =>
      rua.posicoes.forEach((pos, i) => {
        if (pos && pos.lote === nomeLote) {
          detalhes.push({
            rz: pos.rz,
            volume: pos.volume || ''
          });
          rua.posicoes[i] = null; // remove do endereÃ§o
        }
      })
    )
  );

  if (detalhes.length === 0) {
    alert('Nenhuma gaylord alocada neste lote');
    return;
  }

  const parcial = detalhes.length < totalLote;

  // ðŸ”¥ SALVA HISTÃ“RICO CORRETO
  historicoExpedidos.push({
    lote: nomeLote,
    dataHora: new Date().toISOString(),
    parcial,
    detalhes
  });

  // se foi total, remove o lote
  if (!parcial) {
    delete lotes[nomeLote];
  } else {
    // se parcial, atualiza quantidade restante
    lotes[nomeLote].total -= detalhes.length;
  }

  salvarTudo();
  renderMapa();
  renderLotes();
  renderExpedidos();
}

// =======================
// RENDER LOTES ATIVOS
// =======================
function renderLotes() {
  const div = document.getElementById('lotesAtivos');
  if (!div) return;

  div.innerHTML = '';

  Object.entries(lotes).forEach(([nome, data]) => {
    const alocados = contarAlocados(nome);

    const card = document.createElement('div');
    card.className = 'lote-card';
    card.innerHTML = `
      <strong>${nome}</strong><br>
      ${alocados} / ${data.total}<br>
      <button onclick="expedirLote('${nome}')">ðŸ“¤ Expedir</button>
    `;
    card.style.borderLeft = `6px solid ${data.cor}`;

    div.appendChild(card);
  });
}

// =======================
// RENDER EXPEDIDOS
// =======================
function renderExpedidos() {
  const div = document.getElementById('lotesExpedidos');
  if (!div) return;

  div.innerHTML = '';

  historicoExpedidos.forEach(h => {
    const data = new Date(h.dataHora);

    const card = document.createElement('div');
    card.className = 'lote-card';
    card.innerHTML = `
      <strong>${h.lote}</strong><br>
      ${h.parcial ? 'ðŸŸ¡ Parcial' : 'ðŸ”´ Total'}<br>
      ${data.toLocaleDateString()} ${data.toLocaleTimeString()}
      <details>
        <summary>Ver RZ / Volumes</summary>
        ${h.detalhes.map(d => `RZ: ${d.rz} | Vol: ${d.volume || '-'}`).join('<br>')}
      </details>
    `;

    div.appendChild(card);
  });
}

// =======================
// MAPA (SIMPLIFICADO)
// =======================
function renderMapa() {
  // MantÃ©m seu render atual
}

// =======================
// INIT
// =======================
renderMapa();
renderLotes();
renderExpedidos();
</script>

</body>
</html>
