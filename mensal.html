<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>RelatÃ³rio Mensal de ExpediÃ§Ãµes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f4f4;
  padding: 20px;
}

h1, h2 {
  margin-bottom: 10px;
}

.box {
  background: #fff;
  padding: 15px;
  border-radius: 6px;
  margin-bottom: 15px;
}

button {
  padding: 6px 12px;
  cursor: pointer;
}

.resumo {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
  margin-bottom: 15px;
}

.card {
  background: #fff;
  padding: 12px;
  border-radius: 6px;
  min-width: 180px;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
  margin-bottom: 20px;
}

th, td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
}

th {
  background: #eee;
}
</style>
</head>

<body>

<h1>ğŸ“… RelatÃ³rio Mensal de ExpediÃ§Ãµes</h1>

<div class="box">
  <label>
    MÃªs:
    <input type="month" id="mesSelecionado">
  </label>

  <button onclick="gerarRelatorio()">Gerar RelatÃ³rio</button>
  <button onclick="exportarExcel()">ğŸ“Š Exportar Excel</button>
</div>

<div class="resumo" id="resumo"></div>

<h2>ğŸ“¦ Ranking por Lote</h2>
<table>
  <thead>
    <tr>
      <th>Lote</th>
      <th>Quantidade Expedida</th>
    </tr>
  </thead>
  <tbody id="ranking"></tbody>
</table>

<h2>ğŸ“‹ Detalhamento do MÃªs</h2>
<table>
  <thead>
    <tr>
      <th>Data</th>
      <th>Hora</th>
      <th>Lote</th>
      <th>RZ</th>
      <th>Volume</th>
      <th>Tipo</th>
    </tr>
  </thead>
  <tbody id="detalhes"></tbody>
</table>

<!-- BIBLIOTECA EXCEL (OBRIGATÃ“RIA) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
// =======================
// DADOS
// =======================
const historico = JSON.parse(localStorage.getItem('historicoExpedidos')) ||;

// =======================
// GERAR RELATÃ“RIO
// =======================
function gerarRelatorio() {
  const mesInput = document.getElementById('mesSelecionado').value;
  if (!mesInput) {
    alert('Selecione o mÃªs');
    return;
  }

  const [ano, mes] = mesInput.split('-');
  const resumoDiv = document.getElementById('resumo');
  const rankingBody = document.getElementById('ranking');
  const detalhesBody = document.getElementById('detalhes');

  resumoDiv.innerHTML = '';
  rankingBody.innerHTML = '';
  detalhesBody.innerHTML = '';

  let total = 0;
  let parciais = 0;
  let completos = 0;
  const ranking = {};

  historico.forEach(h => {
    const data = new Date(h.dataHora || `${h.data} ${h.hora}`);
    if (data.getFullYear() != ano || data.getMonth() + 1 != mes) return;

    if (h.parcial) parciais++;
    else completos++;

    ranking[h.lote] = (ranking[h.lote] || 0) + h.detalhes.length;

    h.detalhes.forEach(d => {
      total++;
      detalhesBody.innerHTML += `
        <tr>
          <td>${data.toLocaleDateString()}</td>
          <td>${data.toLocaleTimeString()}</td>
          <td>${h.lote}</td>
          <td>${d.rz}</td>
          <td>${d.volume || '-'}</td>
          <td>${h.parcial ? 'Parcial' : 'Total'}</td>
        </tr>
      `;
    });
  });

  Object.entries(ranking).forEach(([lote, qtd]) => {
    rankingBody.innerHTML += `
      <tr>
        <td>${lote}</td>
        <td>${qtd}</td>
      </tr>
    `;
  });

  resumoDiv.innerHTML = `
    <div class="card">ğŸ“¦ Total expedido: <strong>${total}</strong></div>
    <div class="card">ğŸ“ Lotes envolvidos: <strong>${Object.keys(ranking).length}</strong></div>
    <div class="card">ğŸŸ¡ Parciais: <strong>${parciais}</strong></div>
    <div class="card">ğŸ”´ Completos: <strong>${completos}</strong></div>
  `;
}

// =======================
// EXPORTAR EXCEL
// =======================
function exportarExcel() {
  const mesInput = document.getElementById('mesSelecionado').value;
  if (!mesInput) {
    alert('Selecione o mÃªs');
    return;
  }

  const [ano, mes] = mesInput.split('-');

  let total = 0;
  let parciais = 0;
  let completos = 0;
  const lotesResumo = {};
  const detalhes = [];

  historico.forEach(h => {
    const data = new Date(h.dataHora || `${h.data} ${h.hora}`);
    if (data.getFullYear() != ano || data.getMonth() + 1 != mes) return;

    if (h.parcial) parciais++;
    else completos++;

    lotesResumo[h.lote] = (lotesResumo[h.lote] || 0) + h.detalhes.length;

    h.detalhes.forEach(d => {
      total++;
      detalhes.push({
        Data: data.toLocaleDateString(),
        Hora: data.toLocaleTimeString(),
        Lote: h.lote,
        RZ: d.rz,
        Volume: d.volume || '',
        Tipo: h.parcial ? 'Parcial' : 'Total'
      });
    });
  });

  const abaResumo = [
    { Indicador: 'Total expedido', Valor: total },
    { Indicador: 'Lotes envolvidos', Valor: Object.keys(lotesResumo).length },
    { Indicador: 'ExpediÃ§Ãµes parciais', Valor: parciais },
    { Indicador: 'ExpediÃ§Ãµes completas', Valor: completos }
  ];

  const abaLotes = Object.entries(lotesResumo).map(([lote, qtd]) => ({
    Lote: lote,
    Quantidade: qtd
  }));

  const wb = XLSX.utils.book_new();

  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(abaResumo), 'Resumo');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(abaLotes), 'Lotes');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(detalhes), 'Detalhes');

  XLSX.writeFile(wb, `relatorio_${mes}_${ano}.xlsx`);
}
</script>

</body>
</html>
